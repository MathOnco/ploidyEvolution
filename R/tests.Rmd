---
title: "tests"
output: html_document
---

01_diffusion 

Pass condition - distribution of cells should look similar from stochastic component, pde component vs reactran solver.

Total number of cells should stay constant throughout (1e5)


```{r}

proc_data <- function(Mx,id,Lp=1000){
  Np <- ncol(Mx)
  colnames(Mx) <- 1:ncol(Mx)
  Mx$y <- 1:nrow(Mx)
  m <- reshape2::melt(Mx,id.vars="y")
  colnames(m) <- c("y","x","cells")
  m$y <- as.numeric(m$y)*Lp/(Np-1)
  m$x <- as.numeric(m$x)*Lp/(Np-1)
  m$id <- id
  return(m)
}

ut <- read.table("C:/Users/4473331/Documents/projects/ploidyEvolution-main/Julia/test_output/01_diffusion/pde.csv",sep=",")

u0 <- read.table("C:/Users/4473331/Documents/projects/ploidyEvolution-main/Julia/test_output/01_diffusion/u0.csv",sep=",")

x <- rbind(proc_data(ut,"day 10"),proc_data(u0,"day 0"))

p <- ggplot(x,aes(x=x,y=y,fill=cells))+
  facet_grid(cols=vars(id))+
  geom_raster()+
  scale_fill_viridis_c(trans="log")+
  theme_classic(base_size=16)
p

```

```{r}
D <- 500
t <- 5
Mpde <- read.table("C:/Users/4473331/Documents/projects/ploidyEvolution-main/Julia/test_output/01_diffusion/pde.csv",sep=",")
Mstoch <- read.table("C:/Users/4473331/Documents/projects/ploidyEvolution-main/Julia/test_output/01_diffusion/stochastic.csv",sep=",")


pde <- unlist(Mpde[round(nrow(Mpde)/2),])
s <- unlist(Mstoch[round(nrow(Mpde)/2),])
  
Pinit <- ncol(Mpde)/2
  
df <- data.frame(value=c(pde,s),id=c(rep("pde",length(pde)),rep("stoch",length(s))),index=c(1:nrow(Mpde),1:nrow(Mpde)))
df$index <- 1000*df$index/max(df$index)
df$time <- as.numeric(t)
dl <- diff(unique(df$index))[1]
Linit <- Pinit*dl
df$theory <- 1e5/(4*pi*D*df$time)*exp(-(df$index-Linit)^2/(4*D*df$time))*dl^2




library(ggplot2)

p <- ggplot(df,aes(x=index,y=value,color=id))+
  geom_line()+
  geom_line(aes(x=index,y=theory,color="theory"))+
  theme_bw(base_size = 16)+
  scale_y_continuous("cells/site")+
  scale_color_discrete("")
p

sum(Mstoch)
sum(Mpde)
```
02_diffusion

Vessels are place in a line adjacent to the initial cells. This corrals the cells into a strip, reducing to a 1D diffusion problem. Provided we don't let the cells diffuse to the edge of the grid, we can compare this result to a 1d gaussian distribution. 

```{r}
library(ggplot2)
Gauss1D <- function(x,x0,D,t){
  exp(-(x-x0)^2/(4*D*t))/sqrt(4*pi*D*t)
}

proc_data <- function(Mx,id,Lp=1000){
  Np <- ncol(Mx)
  colnames(Mx) <- 1:ncol(Mx)
  Mx$y <- 1:nrow(Mx)
  m <- reshape2::melt(Mx,id.vars="y")
  colnames(m) <- c("y","x","cells")
  m$y <- as.numeric(m$y)*Lp/(Np-1)
  m$x <- as.numeric(m$x)*Lp/(Np-1)
  m$id <- id
  return(m)
}

Mpde <- read.table("C:/Users/4473331/Documents/projects/ploidyEvolution-main/Julia/test_output/02_diffusion/pde.csv",sep=",")
Mstoch <- read.table("C:/Users/4473331/Documents/projects/ploidyEvolution-main/Julia/test_output/02_diffusion/stochastic.csv",sep=",")

x <- rbind(proc_data(Mpde,"pde"),proc_data(Mstoch,"stochastic"))
Npde <- sum(x$cells[x$id=="pde"])
Ns <- sum(x$cells[x$id=="stochastic"])

mx <- median(x$x)
y <- subset(x,x==mx)
y$theory <- sapply(y$y,Gauss1D,x0=mx,D=1000,t=5)*100000*(diff(unique(x$x))[1])/3
p <- ggplot(x,aes(x=x,y=y,fill=cells))+
  facet_grid(cols=vars(id))+
  geom_raster()+
  scale_fill_viridis_c(trans="log")+
  theme_classic(base_size=16)
p

p <- ggplot(y,aes(x=y,y=cells))+
  facet_grid(cols=vars(id))+
  geom_line(aes(color="model"))+
  theme_bw(base_size = 16)+
  geom_line(aes(y=theory,color="theory"))
p


```
03_taxis

to generate some meaningful data for comparison, produce data with a constant gradient after the log transform. Following data has a gradient of 0.01 (Energy/um). taxis (X) is a flux measured in units of speed/gradient, i.e: (um/day)/(Energy/um). 

So if we want the cells to travel at 10uM/day, then:
X=10/0.01 = 1000

```{r}
Np <- 60
L <- 1000
dp <- L/(Np-1)

pp <- seq(dp,1000,dp)/100

Ei <- exp(pp)-0.02
fEi <- log(Ei+0.02)

```

Generate a smooth space for testing chemotaxis.

```{r}

domain_f <- function(i,j, Np, d50){
  
  d_bound <- sqrt(sum((i-Np/2)^2,(j-Np/2)^2))
  1-exp(0.5*(d_bound-d50))/(exp(0.5*(d_bound-d50))+1)
}

Np <- 60
P <- expand.grid(1:Np,1:Np)
names(P) <- c("i","j")
v <- sapply(1:nrow(P), function(i) domain_f(P$i[i],P$j[i],Np, 10))
P$v <- v
p <- ggplot(P,aes(x=i,y=j, fill=v))+
  geom_raster()+
  scale_fill_continuous("energy")
p

ip <- P[P$j==ceiling(Np/2),]

p <- ggplot(ip,aes(x=i,y=log(v+0.02)))+
  geom_line()+
  scale_y_continuous("log(energy+0.02)")
p

```
```{r}
proc_data <- function(Mx,id="",Lp=1000){
  Np <- ncol(Mx)
  colnames(Mx) <- 1:ncol(Mx)
  Mx$y <- 1:nrow(Mx)
  m <- reshape2::melt(Mx,id.vars="y")
  colnames(m) <- c("y","x","cells")
  m$y <- as.numeric(m$y)*Lp/(Np-1)
  m$x <- as.numeric(m$x)*Lp/(Np-1)
  m$id <- id
  return(m)
}
x <- read.table("C:/Users/4473331/Documents/projects/ploidyEvolution-main/Julia/test_output/03_taxis/100pde0.csv",sep=",")

x <- proc_data(x)

p <- ggplot(x,aes(x=x,y=y,fill=cells))+
  geom_raster()+
  scale_fill_viridis_c(trans="log")+
  theme_classic(base_size=16)+
  ggtitle("100 days")
p
sum(x$cells)
```

```{r}
D <- 100
library(ggplot2)
load_test <- function(t){
  dir <- "C:/Users/4473331/Documents/projects/ploidyEvolution-main/Julia/test_output/03_taxis/linear/"
  pde <- paste(dir,t,"pde.csv",sep="")
  stoch <- paste(dir,t,"stoch.csv",sep="")
  
  Mpde <- read.table(pde,sep=",")
  Mstoch <- read.table(stoch,sep=",")
  print(sum(Mpde))
  print(sum(Mstoch))
  
  pde <- unlist(Mpde[round(nrow(Mpde)/2),])
  s <- unlist(Mstoch[round(nrow(Mpde)/2),])
  
  Pinit <- ncol(Mpde)/4
  
  df <- data.frame(value=c(pde,s),id=c(rep("pde",length(pde)),rep("stoch",length(s))),index=c(1:nrow(Mpde),1:nrow(Mpde)))
  df$index <- 1000*df$index/max(df$index)
  df$time <- as.numeric(t)
  dl <- diff(unique(df$index))[1]
  Linit <- Pinit*dl
  df$theory <- 1e5/(4*pi*D*df$time)*exp(-(df$index-Linit-10*df$time)^2/(4*D*df$time))*dl^2
  
  return(df)
  
}


df <- do.call(rbind,lapply(c("010","020","030","040","050"), load_test))

E0 <- read.table("C:/Users/4473331/Documents/projects/ploidyEvolution-main/Julia/test_output/04_taxis/E0.csv",sep=",")

El <- data.frame(E=as.numeric(E0[1,]),L=1:ncol(E0)/ncol(E0)*1000)


t_names <- as_labeller(
     c('10' = "day 10",
       '20' = "day 20",
       '30' = "day 30",
       '40' = "day 40",
       '50' = "day 50"))

df <- df[df$id%in%c("pde","theory")&df$time%in%c(10,20,30,40,50),]

p <- ggplot(El,aes(x=L,y=E))+
  geom_line()+
  theme_bw(base_size=16)+
  scale_y_log10("energy (A.U)")+
  scale_x_continuous("length (\u00b5m)")
p

p <- ggplot(df,aes(x=index,y=value,color=id))+
  facet_grid(rows=vars(time),labeller = t_names)+
  geom_line()+
  geom_line(aes(x=index,y=theory,color="theory"))+
  theme_bw(base_size=16)+
  scale_x_continuous("length (\u00b5m)")+
  scale_y_continuous(expression(cells~site^"-1"))+
  scale_color_discrete("")
p



```

test 05_birth & death


```{r}

nc <- read.table("C:/Users/4473331/Documents/projects/ploidyEvolution-main/Julia/test_output/05_birth/cells.csv",sep=",",header = T)

nc <- reshape2::melt(nc,id.vars="time")

library(ggplot2)

p <- ggplot(nc,aes(x=time,y=value,color=variable))+
  geom_line()+
  scale_y_log10("cells")+
  theme_bw(base_size=16)
p

```